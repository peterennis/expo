{"version":3,"file":"NotificationsHandler.js","sourceRoot":"","sources":["../src/NotificationsHandler.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,YAAY,EAAgB,UAAU,EAAE,QAAQ,EAAE,MAAM,kBAAkB,CAAC;AACpF,OAAO,0BAKN,MAAM,8BAA8B,CAAC;AAGtC,MAAM,OAAO,wBAAyB,SAAQ,UAAU;IAEtD,YAAY,cAAsB,EAAE,YAA0B;QAC5D,KAAK,CAAC,0BAA0B,EAAE,0CAA0C,cAAc,GAAG,CAAC,CAAC;QAC/F,IAAI,CAAC,IAAI,GAAG,EAAE,EAAE,EAAE,cAAc,EAAE,YAAY,EAAE,CAAC;IACnD,CAAC;CACF;AAsBD,iCAAiC;AACjC,MAAM,mBAAmB,GAAG,IAAI,YAAY,CAAC,0BAA0B,CAAC,CAAC;AAEzE,MAAM,2BAA2B,GAAG,sBAAsB,CAAC;AAC3D,MAAM,kCAAkC,GAAG,6BAA6B,CAAC;AAEzE,IAAI,kBAAkB,GAAwB,IAAI,CAAC;AACnD,IAAI,yBAAyB,GAAwB,IAAI,CAAC;AAE1D,MAAM,UAAU,sBAAsB,CAAC,OAAmC;IACxE,IAAI,kBAAkB,EAAE;QACtB,kBAAkB,CAAC,MAAM,EAAE,CAAC;QAC5B,kBAAkB,GAAG,IAAI,CAAC;KAC3B;IACD,IAAI,yBAAyB,EAAE;QAC7B,yBAAyB,CAAC,MAAM,EAAE,CAAC;QACnC,yBAAyB,GAAG,IAAI,CAAC;KAClC;IAED,IAAI,OAAO,EAAE;QACX,kBAAkB,GAAG,mBAAmB,CAAC,WAAW,CAClD,2BAA2B,EAC3B,KAAK,EAAE,EAAE,EAAE,EAAE,YAAY,EAAE,EAAE,EAAE;YAC7B,IAAI;gBACF,MAAM,EAAE,GAAG,EAAE,OAAO,EAAE,GAAG,YAAY,EAAE,GAAG,MAAM,OAAO,CAAC,kBAAkB,CAAC,YAAY,CAAC,CAAC;gBACzF,MAAM,yBAAyB,GAAG,EAAE,GAAG,EAAE,OAAO,EAAE,CAAC;gBACnD,MAAM,cAAc,GAA+B;oBACjD,GAAG,YAAY;oBACf,GAAG,yBAAyB,CAAC,QAAQ,CAAC,EAAE,CAAC;iBAC1C,CAAC;gBACF,MAAM,0BAA0B,CAAC,uBAAuB,CAAC,EAAE,EAAE,cAAc,CAAC,CAAC;gBAC7E,sFAAsF;gBACtF,2BAA2B;gBAC3B,OAAO,CAAC,aAAa,EAAE,CAAC,EAAE,CAAC,CAAC;aAC7B;YAAC,OAAO,KAAK,EAAE;gBACd,sFAAsF;gBACtF,2BAA2B;gBAC3B,OAAO,CAAC,WAAW,EAAE,CAAC,KAAK,CAAC,CAAC;aAC9B;QACH,CAAC,CACF,CAAC;QAEF,yBAAyB,GAAG,mBAAmB,CAAC,WAAW,CACzD,kCAAkC,EAClC,CAAC,EAAE,EAAE,EAAE,YAAY,EAAE,EAAE,EAAE,CACvB,OAAO,CAAC,WAAW,EAAE,CAAC,IAAI,wBAAwB,CAAC,EAAE,EAAE,YAAY,CAAC,CAAC,CACxE,CAAC;KACH;AACH,CAAC","sourcesContent":["import { EventEmitter, Subscription, CodedError, Platform } from '@unimodules/core';\nimport NotificationsHandlerModule, {\n  BaseNotificationBehavior,\n  IosNotificationBehavior,\n  AndroidNotificationBehavior,\n  NativeNotificationBehavior,\n} from './NotificationsHandlerModule';\nimport { Notification } from './NotificationsEmitter.types';\n\nexport class NotificationTimeoutError extends CodedError {\n  info: { notification: Notification; id: string };\n  constructor(notificationId: string, notification: Notification) {\n    super('ERR_NOTIFICATION_TIMEOUT', `Notification handling timed out for ID ${notificationId}.`);\n    this.info = { id: notificationId, notification };\n  }\n}\n\nexport type NotificationHandlingError = NotificationTimeoutError | Error;\n\nexport interface NotificationBehavior extends BaseNotificationBehavior {\n  ios?: IosNotificationBehavior;\n  android?: AndroidNotificationBehavior;\n}\n\nexport interface NotificationHandler {\n  handleNotification: (notification: Notification) => Promise<NotificationBehavior>;\n  handleSuccess?: (notificationId: string) => void;\n  handleError?: (error: NotificationHandlingError) => void;\n}\n\ntype HandleNotificationEvent = {\n  id: string;\n  notification: Notification;\n};\n\ntype HandleNotificationTimeoutEvent = HandleNotificationEvent;\n\n// Web uses SyntheticEventEmitter\nconst notificationEmitter = new EventEmitter(NotificationsHandlerModule);\n\nconst handleNotificationEventName = 'onHandleNotification';\nconst handleNotificationTimeoutEventName = 'onHandleNotificationTimeout';\n\nlet handleSubscription: Subscription | null = null;\nlet handleTimeoutSubscription: Subscription | null = null;\n\nexport function setNotificationHandler(handler: NotificationHandler | null): void {\n  if (handleSubscription) {\n    handleSubscription.remove();\n    handleSubscription = null;\n  }\n  if (handleTimeoutSubscription) {\n    handleTimeoutSubscription.remove();\n    handleTimeoutSubscription = null;\n  }\n\n  if (handler) {\n    handleSubscription = notificationEmitter.addListener<HandleNotificationEvent>(\n      handleNotificationEventName,\n      async ({ id, notification }) => {\n        try {\n          const { ios, android, ...baseBehavior } = await handler.handleNotification(notification);\n          const platformSpecificBehaviors = { ios, android };\n          const nativeBehavior: NativeNotificationBehavior = {\n            ...baseBehavior,\n            ...platformSpecificBehaviors[Platform.OS],\n          };\n          await NotificationsHandlerModule.handleNotificationAsync(id, nativeBehavior);\n          // TODO: Remove eslint-disable once we upgrade to a version that supports ?. notation.\n          // eslint-disable-next-line\n          handler.handleSuccess?.(id);\n        } catch (error) {\n          // TODO: Remove eslint-disable once we upgrade to a version that supports ?. notation.\n          // eslint-disable-next-line\n          handler.handleError?.(error);\n        }\n      }\n    );\n\n    handleTimeoutSubscription = notificationEmitter.addListener<HandleNotificationTimeoutEvent>(\n      handleNotificationTimeoutEventName,\n      ({ id, notification }) =>\n        handler.handleError?.(new NotificationTimeoutError(id, notification))\n    );\n  }\n}\n"]}